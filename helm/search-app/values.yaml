application-template:
  name: search-app
  namespace: search-app
  clusterSecretStoreName: cluster-secret-store
  serviceAccount:
    create: true
    name: search-app

  configMaps:
    - name: search-app-config
      data:
        API_ENDPOINT: "http://search-app-backend.search-app.svc.cluster.local:8080"
        MYSQL_HOST: "search-app-mysql.search-app.svc.cluster.local"
        MYSQL_DATABASE: "searchapp"
        REDIS_HOST: "search-app-redis.search-app.svc.cluster.local:6379"

  deployments:
    - name: search-app-frontend
      image:
        repository: ccrawford4/search-app-frontend
        pullPolicy: IfNotPresent
        tag: "v0.0.1"
        port: 3000
      service:
        enabled: true
        port: 3000
      container:
        envFrom:
          - configMapRef:
              name: search-app-config
        env:
          - name: GITHUB_ID
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: github-id
          - name: GITHUB_SECRET
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: github-secret
          - name: GOOGLE_ID
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: google-id
          - name: GOOGLE_SECRET
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: google-secret
          - name: NEXTAUTH_SECRET
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: nextauth-secret
          - name: NEXTAUTH_URL
            value: "https://search.calum.run"

    - name: search-app-backend
      image:
        repository: ccrawford4/searchapi
        pullPolicy: IfNotPresent
        tag: "arm64-v1.0.0"
        port: 8080
      service:
        enabled: true
        port: 8080
      container:
        envFrom:
          - configMapRef:
              name: search-app-config
        env:
          - name: MYSQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: db-username
          - name: MYSQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: db-password
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: search-app-secrets
                key: redis-password
 
  secrets:
    - name: search-app-secrets
      targetName: search-app-secrets
      data:
        - secretKey: db-username
          remoteRefKey: search-app-db-username
        - secretKey: db-password
          remoteRefKey: search-app-db-password
        - secretKey: redis-password
          remoteRefKey: search-app-redis-password
        - secretKey: github-id
          remoteRefKey: search-app-github-id
        - secretKey: github-secret
          remoteRefKey: search-app-github-secret
        - secretKey: google-id
          remoteRefKey: search-app-google-id
        - secretKey: google-secret
          remoteRefKey: search-app-google-secret
        - secretKey: nextauth-secret
          remoteRefKey: search-app-nextauth-secret

mysql:
  name: search-app-mysql
  namespace: search-app
  clusterSecretStoreName: cluster-secret-store
  image:
    repository: mysql
    tag: "8.0"
    pullPolicy: IfNotPresent
  database_name: searchapp
  service:
    type: ClusterIP
    port: 3306
  persistence:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 20Gi
  secrets:
    useExternalSecrets: true
    externalSecrets:
      rootPasswordKey: search-app-db-root-password
      userPasswordKey: search-app-db-password
      usernameKey: search-app-db-username
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

redis:
  name: search-app-redis
  namespace: search-app
  clusterSecretStoreName: cluster-secret-store
  image:
    repository: redis
    tag: "7.0"
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 6379
  persistence:
    enabled: true
    size: 1Gi
  secrets:
    useExternalSecrets: true
    externalSecrets:
      passwordKey: search-app-redis-password
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
